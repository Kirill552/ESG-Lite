# План реализации

- [x] 1. Исправить удаление системного сообщения в интерфейсе






  - Удалить карточку с сообщением "Система готова к работе!" со страницы создания отчетов
  - Сохранить всю существующую функциональность при очистке интерфейса
  - Протестировать корректное отображение страницы без статусного сообщения
  - _Требования: 1.1, 1.2, 1.3_

- [x] 2. Исправить нарушение ограничения внешнего ключа базы данных


- [x] 2.1 Реализовать проверку существования пользователя и автосоздание



  - Добавить функцию проверки существования пользователя в БД перед созданием отчетов
  - Реализовать автоматическое создание пользователя из данных Clerk при его отсутствии
  - Обработать крайние случаи, когда данные пользователя Clerk неполные
  - _Требования: 2.1, 2.2, 2.3_

- [x] 2.2 Обновить API создания отчетов для обработки пользовательских ограничений


  - Изменить POST /api/reports маршрут для обеспечения существования пользователя перед созданием отчета
  - Добавить правильную обработку ошибок для операций БД, связанных с пользователями
  - Реализовать обработку транзакций для создания пользователя и отчета
  - _Требования: 2.1, 2.2, 2.4_

- [ ] 3. Создать шаблон отчета 296-ФЗ, соответствующий требованиям 2025 года
- [ ] 3.1 Реализовать новую HTML структуру шаблона 296-ФЗ
  - Создать новый HTML шаблон на основе спецификаций ПП 707 к 296-ФЗ
  - Реализовать заполнители токенов snake_case для всех обязательных полей
  - Добавить правильные структуры таблиц для реквизитов организации, процессов и выбросов
  - _Требования: 3.1, 3.2, 3.3, 3.4_

- [ ] 3.2 Добавить секцию реквизитов организации с правильным сопоставлением полей
  - Реализовать секцию информации об организации со всеми обязательными полями
  - Добавить структуру таблицы перечня процессов и объектов
  - Создать таблицы данных о выбросах с правильными расчетами CO₂-эквивалента
  - _Требования: 3.1, 3.2, 3.3_

- [ ] 3.3 Реализовать секции методологии и подписи
  - Добавить секцию методологии и коэффициентов с правильным форматированием
  - Реализовать секцию климатических проектов (опционально)
  - Создать секцию подписи с правильными полями валидации
  - _Требования: 3.1, 3.2, 3.4_

- [ ] 4. Создать шаблон квартального отчета CBAM
- [ ] 4.1 Реализовать HTML структуру шаблона CBAM
  - Создать HTML шаблон на основе EU Regulation 2023/1773
  - Реализовать секцию информации о декларанте с полем EORI
  - Добавить таблицу декларации Annex I со всеми обязательными колонками
  - _Требования: 4.1, 4.2, 4.3, 4.4_

- [ ] 4.2 Добавить специфичную для CBAM валидацию и форматирование данных
  - Реализовать валидацию и форматирование CN кодов
  - Добавить обработку полей страны и UN/LOCODE
  - Создать поля расчета коэффициентов эмиссии
  - _Требования: 4.1, 4.2, 4.3, 4.4_

- [ ] 5. Улучшить интеграцию CHECKO API и сопоставление данных
- [ ] 5.1 Улучшить сопоставление данных компании с токенами шаблона
  - Обновить API company-info для сопоставления ответа CHECKO с токенами snake_case
  - Добавить недостающие сопоставления полей для ОКПО, ОКТМО, email, телефон
  - Реализовать правильные функции преобразования данных
  - _Требования: 5.1, 5.2, 5.4_

- [ ] 5.2 Добавить обработку резервных вариантов для неполных данных CHECKO
  - Реализовать корректную обработку когда CHECKO API возвращает неполные данные
  - Добавить возможности ручного дополнения полей
  - Создать валидацию для обязательных и опциональных полей
  - _Требования: 5.2, 5.3, 5.5_

- [ ] 5.3 Реализовать обработку ошибок CHECKO API и резервные варианты
  - Добавить правильную обработку ошибок когда CHECKO API недоступен
  - Реализовать переход к режиму ручного ввода данных
  - Добавить понятные пользователю сообщения об ошибках и руководство
  - _Требования: 5.3, 5.5_

- [ ] 6. Создать систему рендеринга шаблонов с заменой токенов
- [ ] 6.1 Реализовать движок замены токенов
  - Создать функцию замены токенов snake_case на фактические значения данных
  - Добавить валидацию для обеспечения замены всех обязательных токенов
  - Реализовать правильное экранирование для HTML контента
  - _Требования: 6.1, 6.2, 6.4_

- [ ] 6.2 Добавить генерацию PDF с правильной поддержкой шрифтов
  - Обновить генерацию PDF в Playwright для использования шрифтов DejaVu Sans
  - Обеспечить правильный рендеринг кириллического текста в генерируемых PDF
  - Добавить сохранение форматирования таблиц при конвертации в PDF
  - _Требования: 6.3, 6.5_

- [ ] 6.3 Реализовать валидацию шаблонов и обработку ошибок
  - Добавить валидацию для отсутствующих или недействительных данных шаблона
  - Реализовать корректную обработку пустых полей против отсутствующих токенов
  - Создать комплексное логирование ошибок для проблем с шаблонами
  - _Требования: 6.2, 6.4_

- [ ] 7. Добавить комплексное тестирование всех компонентов
- [ ] 7.1 Создать юнит-тесты для замены токенов и валидации данных
  - Написать тесты для функций замены токенов snake_case
  - Добавить тесты для преобразования данных CHECKO API
  - Создать тесты валидации для проверки обязательных полей
  - _Требования: 2.4, 3.4, 4.4, 5.4, 6.2_

- [ ] 7.2 Реализовать интеграционные тесты для генерации отчетов
  - Создать end-to-end тесты для генерации отчетов 296-ФЗ
  - Добавить интеграционные тесты для создания отчетов CBAM
  - Протестировать генерацию PDF с различными сценариями данных
  - _Требования: 2.4, 3.4, 4.4, 6.3, 6.5_

- [ ] 8. Обновить интеграцию рабочего процесса создания отчетов
- [ ] 8.1 Интегрировать новые шаблоны с существующим процессом создания отчетов
  - Обновить API создания отчетов для использования новой системы шаблонов
  - Обеспечить обратную совместимость с существующей функциональностью
  - Добавить правильный выбор шаблона на основе типа отчета
  - _Требования: 2.4, 3.1, 4.1, 6.1_

- [ ] 8.2 Протестировать полный рабочий процесс генерации отчетов
  - Проверить end-to-end функциональность от поиска компании до генерации PDF
  - Протестировать с реальными данными CHECKO API и сценариями мок-данных
  - Валидировать соответствие сгенерированных отчетов нормативным требованиям
  - _Требования: 2.4, 3.4, 4.4, 5.1, 6.5_